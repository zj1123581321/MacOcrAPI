# OCR Mac API ä½¿ç”¨æŒ‡å—

## ğŸ“‹ ç›®å½•
1. [HTTP è¯·æ±‚æ ¼å¼](#http-è¯·æ±‚æ ¼å¼)
2. [Base64 å›¾ç‰‡æ ¼å¼](#base64-å›¾ç‰‡æ ¼å¼)
3. [è¯·æ±‚å‚æ•°è¯¦è§£](#è¯·æ±‚å‚æ•°è¯¦è§£)
4. [å“åº”æ ¼å¼](#å“åº”æ ¼å¼)
5. [é”™è¯¯å¤„ç†](#é”™è¯¯å¤„ç†)
6. [ç¤ºä¾‹ä»£ç ](#ç¤ºä¾‹ä»£ç )
7. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

## ğŸš€ HTTP è¯·æ±‚æ ¼å¼

### åŸºæœ¬è¯·æ±‚ç»“æ„

```bash
POST /predict HTTP/1.1
Host: localhost:8004
Content-Type: application/json
Authorization: Bearer YOUR_TOKEN

{
    "image_base64": "å›¾ç‰‡çš„base64ç¼–ç ",
    "recognition_level": "accurate",
    "confidence_threshold": 0.0
}
```

### ä½¿ç”¨ curl å‘é€è¯·æ±‚

```bash
curl --location 'http://localhost:8004/predict' \
--header 'Content-Type: application/json' \
--header 'Authorization: Bearer test' \
--data '{
    "image_base64": "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==",
    "recognition_level": "accurate",
    "confidence_threshold": 0.0
}'
```

## ğŸ–¼ï¸ Base64 å›¾ç‰‡æ ¼å¼

### ä»€ä¹ˆæ˜¯ Base64ï¼Ÿ

Base64 æ˜¯ä¸€ç§ç¼–ç æ–¹å¼ï¼Œå°†äºŒè¿›åˆ¶æ•°æ®è½¬æ¢ä¸ºæ–‡æœ¬å­—ç¬¦ä¸²ã€‚å¯¹äºå›¾ç‰‡ï¼Œå®ƒå…è®¸æˆ‘ä»¬åœ¨ JSON ä¸­ä¼ è¾“å›¾åƒæ•°æ®ã€‚

### æ”¯æŒçš„å›¾ç‰‡æ ¼å¼

- **PNG** (æ¨è)
- **JPEG/JPG**
- **BMP**
- **GIF**
- **TIFF**

### Base64 ç¼–ç ç¤ºä¾‹

#### 1. ä»æ–‡ä»¶ç”Ÿæˆ Base64

```python
import base64

def image_to_base64(image_path):
    """å°†å›¾ç‰‡æ–‡ä»¶è½¬æ¢ä¸º base64 å­—ç¬¦ä¸²"""
    with open(image_path, "rb") as image_file:
        image_data = image_file.read()
        base64_string = base64.b64encode(image_data).decode('utf-8')
        return base64_string

# ä½¿ç”¨ç¤ºä¾‹
base64_data = image_to_base64("your_image.png")
print(f"Base64 é•¿åº¦: {len(base64_data)} å­—ç¬¦")
```

#### 2. ä» URL ç”Ÿæˆ Base64

```python
import requests
import base64

def url_to_base64(image_url):
    """ä» URL ä¸‹è½½å›¾ç‰‡å¹¶è½¬æ¢ä¸º base64"""
    response = requests.get(image_url)
    if response.status_code == 200:
        base64_string = base64.b64encode(response.content).decode('utf-8')
        return base64_string
    else:
        raise Exception(f"ä¸‹è½½å¤±è´¥: {response.status_code}")

# ä½¿ç”¨ç¤ºä¾‹
base64_data = url_to_base64("https://example.com/image.png")
```

#### 3. ä»å‰ªè´´æ¿ç”Ÿæˆ Base64 (macOS)

```python
import subprocess
import base64

def clipboard_to_base64():
    """ä»å‰ªè´´æ¿è·å–å›¾ç‰‡å¹¶è½¬æ¢ä¸º base64"""
    try:
        # è·å–å‰ªè´´æ¿ä¸­çš„å›¾ç‰‡æ•°æ®
        result = subprocess.run(
            ['osascript', '-e', 'the clipboard as Â«class PNGfÂ»'], 
            capture_output=True, 
            text=True
        )
        
        if result.returncode == 0:
            # å¤„ç†è¾“å‡ºå¹¶è½¬æ¢ä¸º base64
            hex_data = result.stdout.strip().replace('Â«data PNGf', '').replace('Â»', '')
            binary_data = bytes.fromhex(hex_data)
            base64_string = base64.b64encode(binary_data).decode('utf-8')
            return base64_string
        else:
            raise Exception("å‰ªè´´æ¿ä¸­æ²¡æœ‰å›¾ç‰‡æ•°æ®")
    except Exception as e:
        print(f"å‰ªè´´æ¿è½¬æ¢å¤±è´¥: {e}")
        return None
```

### Base64 æ ¼å¼è¦æ±‚

#### âœ… æ­£ç¡®æ ¼å¼
```
iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==
```

#### âŒ é”™è¯¯æ ¼å¼
```
data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==
```

**æ³¨æ„**: ä¸è¦åŒ…å« `data:image/png;base64,` å‰ç¼€ï¼

## ğŸ“ è¯·æ±‚å‚æ•°è¯¦è§£

### å¿…å¡«å‚æ•°

| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `image_base64` | string | å›¾ç‰‡çš„ Base64 ç¼–ç å­—ç¬¦ä¸² |

### å¯é€‰å‚æ•°

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `recognition_level` | string | `"accurate"` | è¯†åˆ«ç²¾åº¦çº§åˆ« |
| `confidence_threshold` | float | `0.0` | ç½®ä¿¡åº¦é˜ˆå€¼ (0.0-1.0) |
| `language_preference` | array | `["zh-Hans", "en"]` | è¯­è¨€åå¥½ |
| `framework` | string | `"vision"` | ä½¿ç”¨çš„æ¡†æ¶ |

### è¯†åˆ«çº§åˆ«é€‰é¡¹

- `"fast"` - å¿«é€Ÿè¯†åˆ«ï¼Œç²¾åº¦ä¸€èˆ¬
- `"accurate"` - ç²¾ç¡®è¯†åˆ«ï¼Œé€Ÿåº¦è¾ƒæ…¢ (æ¨è)

### æ¡†æ¶é€‰é¡¹

- `"vision"` - Apple Vision æ¡†æ¶ (æ¨è)
- `"livetext"` - Apple LiveText æ¡†æ¶

## ğŸ“Š å“åº”æ ¼å¼

### æˆåŠŸå“åº” (200 OK)

```json
[
    {
        "dt_boxes": [[46,54],[127,54],[127,79],[46,79]],
        "rec_txt": "Hello OCR!",
        "score": 0.9988542000452677
    },
    {
        "dt_boxes": [[46,126],[127,126],[127,152],[46,152]],
        "rec_txt": "æµ‹è¯•æ–‡æœ¬",
        "score": 0.9995218416055044
    }
]
```

### å“åº”å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `dt_boxes` | array | æ–‡æœ¬è¾¹ç•Œæ¡†åæ ‡ [[å·¦ä¸Š],[å³ä¸Š],[å³ä¸‹],[å·¦ä¸‹]] |
| `rec_txt` | string | è¯†åˆ«å‡ºçš„æ–‡æœ¬å†…å®¹ |
| `score` | float | ç½®ä¿¡åº¦åˆ†æ•° (0.0-1.0) |

## âŒ é”™è¯¯å¤„ç†

### å¸¸è§é”™è¯¯ç 

#### 400 Bad Request
```json
{
    "detail": "Invalid base64 format"
}
```

#### 401 Unauthorized
```json
{
    "detail": "Invalid authentication credentials"
}
```

#### 422 Unprocessable Entity
```json
{
    "detail": [
        {
            "loc": ["body", "image_base64"],
            "msg": "field required",
            "type": "value_error.missing"
        }
    ]
}
```

#### 500 Internal Server Error
```json
{
    "detail": "OCR processing failed: image file is truncated"
}
```

### é”™è¯¯æ’æŸ¥æ­¥éª¤

1. **éªŒè¯ Base64 æ ¼å¼**
   ```python
   import base64
   
   def validate_base64(base64_string):
       try:
           base64.b64decode(base64_string, validate=True)
           return True
       except Exception as e:
           print(f"Base64 éªŒè¯å¤±è´¥: {e}")
           return False
   ```

2. **æ£€æŸ¥å›¾ç‰‡å®Œæ•´æ€§**
   ```python
   from PIL import Image
   import io
   
   def validate_image(base64_string):
       try:
           image_data = base64.b64decode(base64_string)
           image = Image.open(io.BytesIO(image_data))
           image.verify()
           return True
       except Exception as e:
           print(f"å›¾ç‰‡éªŒè¯å¤±è´¥: {e}")
           return False
   ```

## ğŸ’» ç¤ºä¾‹ä»£ç 

### Python å®Œæ•´ç¤ºä¾‹

```python
import requests
import base64
from PIL import Image
import io

def ocr_request(image_path, server_url="http://localhost:8004"):
    """å‘é€ OCR è¯·æ±‚"""
    
    # 1. è¯»å–å›¾ç‰‡å¹¶è½¬æ¢ä¸º base64
    with open(image_path, "rb") as image_file:
        image_data = image_file.read()
        base64_string = base64.b64encode(image_data).decode('utf-8')
    
    # 2. å‡†å¤‡è¯·æ±‚
    url = f"{server_url}/predict"
    headers = {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer test'
    }
    
    data = {
        "image_base64": base64_string,
        "recognition_level": "accurate",
        "confidence_threshold": 0.0
    }
    
    # 3. å‘é€è¯·æ±‚
    try:
        response = requests.post(url, headers=headers, json=data, timeout=30)
        
        if response.status_code == 200:
            results = response.json()
            print(f"âœ… è¯†åˆ«æˆåŠŸ! æ‰¾åˆ° {len(results)} ä¸ªæ–‡æœ¬")
            
            for i, result in enumerate(results, 1):
                print(f"{i}. æ–‡æœ¬: '{result['rec_txt']}'")
                print(f"   ç½®ä¿¡åº¦: {result['score']:.4f}")
                print(f"   åæ ‡: {result['dt_boxes']}")
            
            return results
        else:
            print(f"âŒ è¯·æ±‚å¤±è´¥: {response.status_code}")
            print(f"é”™è¯¯: {response.text}")
            return None
            
    except Exception as e:
        print(f"âŒ è¯·æ±‚å¼‚å¸¸: {e}")
        return None

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    results = ocr_request("test_image.png")
```

### JavaScript ç¤ºä¾‹

```javascript
async function ocrRequest(imageFile, serverUrl = "http://localhost:8004") {
    // 1. è¯»å–æ–‡ä»¶å¹¶è½¬æ¢ä¸º base64
    const reader = new FileReader();
    const base64String = await new Promise((resolve, reject) => {
        reader.onload = () => {
            const base64 = reader.result.split(',')[1]; // ç§»é™¤ data URL å‰ç¼€
            resolve(base64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(imageFile);
    });
    
    // 2. å‘é€è¯·æ±‚
    try {
        const response = await fetch(`${serverUrl}/predict`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer test'
            },
            body: JSON.stringify({
                image_base64: base64String,
                recognition_level: "accurate",
                confidence_threshold: 0.0
            })
        });
        
        if (response.ok) {
            const results = await response.json();
            console.log(`âœ… è¯†åˆ«æˆåŠŸ! æ‰¾åˆ° ${results.length} ä¸ªæ–‡æœ¬`);
            
            results.forEach((result, index) => {
                console.log(`${index + 1}. æ–‡æœ¬: '${result.rec_txt}'`);
                console.log(`   ç½®ä¿¡åº¦: ${result.score.toFixed(4)}`);
                console.log(`   åæ ‡: ${JSON.stringify(result.dt_boxes)}`);
            });
            
            return results;
        } else {
            console.error(`âŒ è¯·æ±‚å¤±è´¥: ${response.status}`);
            const error = await response.text();
            console.error(`é”™è¯¯: ${error}`);
            return null;
        }
        
    } catch (error) {
        console.error(`âŒ è¯·æ±‚å¼‚å¸¸: ${error}`);
        return null;
    }
}

// ä½¿ç”¨ç¤ºä¾‹
document.getElementById('fileInput').addEventListener('change', async (event) => {
    const file = event.target.files[0];
    if (file) {
        const results = await ocrRequest(file);
    }
});
```

## â“ å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•å¤„ç†å¤§å›¾ç‰‡ï¼Ÿ

**A**: å»ºè®®åœ¨å‘é€å‰å‹ç¼©å›¾ç‰‡ï¼š

```python
from PIL import Image

def compress_image(image_path, max_size=(1920, 1080), quality=85):
    """å‹ç¼©å›¾ç‰‡"""
    image = Image.open(image_path)
    image.thumbnail(max_size, Image.Resampling.LANCZOS)
    
    # ä¿å­˜å‹ç¼©åçš„å›¾ç‰‡
    buffer = io.BytesIO()
    image.save(buffer, format='JPEG', quality=quality)
    return buffer.getvalue()
```

### Q2: å¦‚ä½•æé«˜è¯†åˆ«å‡†ç¡®åº¦ï¼Ÿ

**A**: 
1. ä½¿ç”¨é«˜è´¨é‡ã€é«˜åˆ†è¾¨ç‡çš„å›¾ç‰‡
2. ç¡®ä¿æ–‡å­—æ¸…æ™°ï¼Œå¯¹æ¯”åº¦é«˜
3. é€‰æ‹©åˆé€‚çš„è¯­è¨€åå¥½
4. ä½¿ç”¨ `"accurate"` è¯†åˆ«çº§åˆ«

### Q3: ä¸ºä»€ä¹ˆä¼šå‡ºç° "image file is truncated" é”™è¯¯ï¼Ÿ

**A**: å¯èƒ½åŸå› ï¼š
1. Base64 å­—ç¬¦ä¸²ä¸å®Œæ•´
2. å›¾ç‰‡æ–‡ä»¶æŸå
3. ç½‘ç»œä¼ è¾“ä¸­æ•°æ®ä¸¢å¤±
4. ç¼–ç è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯

è§£å†³æ–¹æ³•ï¼š
1. éªŒè¯ Base64 æ ¼å¼
2. æ£€æŸ¥åŸå›¾ç‰‡å®Œæ•´æ€§
3. é‡æ–°ç”Ÿæˆ Base64 ç¼–ç 

### Q4: å¦‚ä½•æ‰¹é‡å¤„ç†å¤šå¼ å›¾ç‰‡ï¼Ÿ

**A**: ä½¿ç”¨å¼‚æ­¥å¤„ç†ï¼š

```python
import asyncio
import aiohttp

async def batch_ocr(image_paths, server_url="http://localhost:8004"):
    """æ‰¹é‡ OCR å¤„ç†"""
    async with aiohttp.ClientSession() as session:
        tasks = []
        for image_path in image_paths:
            task = ocr_single_image(session, image_path, server_url)
            tasks.append(task)
        
        results = await asyncio.gather(*tasks)
        return results

async def ocr_single_image(session, image_path, server_url):
    """å•å¼ å›¾ç‰‡ OCR"""
    # è¯»å–å¹¶ç¼–ç å›¾ç‰‡
    with open(image_path, "rb") as f:
        base64_string = base64.b64encode(f.read()).decode('utf-8')
    
    data = {
        "image_base64": base64_string,
        "recognition_level": "accurate"
    }
    
    headers = {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer test'
    }
    
    async with session.post(f"{server_url}/predict", json=data, headers=headers) as response:
        if response.status == 200:
            return await response.json()
        else:
            return None
```

## ğŸ”§ æµ‹è¯•å·¥å…·

ä½¿ç”¨æä¾›çš„æµ‹è¯•è„šæœ¬ï¼š

```bash
# è¿è¡Œæµ‹è¯•
python3 test_request.py

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
curl http://localhost:8004/health
```

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·ï¼š

1. æ£€æŸ¥æœåŠ¡æ—¥å¿—ï¼š`tail -f logs/ocrmac_api.log`
2. éªŒè¯å›¾ç‰‡æ ¼å¼å’Œ Base64 ç¼–ç 
3. ç¡®è®¤ç½‘ç»œè¿æ¥æ­£å¸¸
4. æ£€æŸ¥è®¤è¯ä»¤ç‰Œæ˜¯å¦æ­£ç¡®

---

**æœ€åæ›´æ–°**: 2024å¹´7æœˆ5æ—¥ 