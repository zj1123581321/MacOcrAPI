# OCR Mac API 项目设计文档

## 项目概述

基于 ocrmac 项目的二次开发，将其封装成高并发的 HTTP API 服务。支持 base64 图像输入，提供完整的 macOS 自动启动解决方案。

## 核心需求

1. **高并发支持** - 基于 FastAPI 异步框架
2. **Base64 图像输入** - 支持直接传入 base64 编码的图像数据
3. **macOS 自动启动** - 通过 LaunchAgent 实现系统级自动启动
4. **安全认证** - Bearer Token 认证机制
5. **完整日志** - 详细的请求和错误日志记录

## 技术架构

### 1. 核心组件

- **FastAPI** - 高性能 Web 框架
- **ocrmac** - macOS 原生 OCR 能力
- **Apple Vision Framework** - 底层 OCR 引擎
- **pydantic** - 数据验证和序列化
- **uvicorn** - ASGI 服务器

### 2. 项目结构

```
250705_OcrMacApi/
├── ocrmac-main/           # ocrmac 源码
├── config.py              # 配置管理
├── models.py              # 数据模型
├── ocr_service.py         # OCR 服务封装
├── api.py                 # FastAPI 路由
├── main.py                # 主程序入口
├── requirements.txt       # Python 依赖
├── startup.sh             # 启动脚本
├── install.sh             # 安装脚本
├── setup_autostart.sh     # 自动启动设置
├── com.ocrmac.api.plist   # macOS LaunchAgent 配置
├── config.example.env     # 环境变量示例
└── README.md              # 项目文档
```

### 3. API 接口设计

#### 主要接口

- `POST /predict` - OCR 识别（标准格式）
- `POST /predict-detailed` - 详细识别结果
- `GET /health` - 健康检查
- `GET /stats` - 统计信息
- `GET /supported-languages` - 支持的语言

#### 示例请求

```bash
curl --location 'http://localhost:8003/predict' \
--header 'Content-Type: application/json' \
--header 'Authorization: Bearer test' \
--data '{
    "image_base64": "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=="
}'
```

#### 示例响应

```json
[
    {
        "dt_boxes": [[46,54],[127,54],[127,79],[46,79]],
        "rec_txt": "175.0M",
        "score": 0.9988542000452677
    },
    {
        "dt_boxes": [[46,126],[127,126],[127,152],[46,152]],
        "rec_txt": "150.0M",
        "score": 0.9995218416055044
    }
]
```

## 实现特点

### 1. 高并发处理

- 异步 I/O 操作
- 线程池处理 OCR 计算
- 多进程支持
- 请求队列管理

### 2. 安全机制

- Bearer Token 认证
- 输入验证和清理
- 图像大小限制
- 错误处理和日志记录

### 3. 生产就绪

- 完整的日志系统
- 健康检查接口
- 性能监控
- 自动重启机制

### 4. macOS 集成

- LaunchAgent 自动启动
- 系统级服务管理
- 日志文件管理
- 环境变量配置

## 部署和使用

### 1. 快速安装

```bash
chmod +x install.sh
./install.sh
```

### 2. 配置服务

```bash
# 复制配置文件
cp config.example.env .env

# 编辑配置
nano .env
```

### 3. 启动服务

```bash
# 前台启动
python3 main.py

# 后台启动
./startup.sh

# 自动启动设置
./setup_autostart.sh
```

### 4. 服务管理

```bash
# 启动服务
launchctl start com.ocrmac.api

# 停止服务
launchctl stop com.ocrmac.api

# 查看状态
launchctl list | grep com.ocrmac.api
```

## 性能优化

### 1. 配置优化

- 根据 CPU 核心数调整工作进程数
- 设置合适的图像大小限制
- 选择合适的识别级别

### 2. 系统优化

- 使用 SSD 存储
- 确保充足的内存
- 配置适当的日志轮转

## 监控和维护

### 1. 日志监控

- 标准输出日志：`logs/ocrmac_api.log`
- 错误日志：`logs/ocrmac_api_error.log`
- 实时监控：`tail -f logs/ocrmac_api.log`

### 2. 性能监控

- 统计接口：`GET /stats`
- 健康检查：`GET /health`
- 系统资源监控

### 3. 故障排除

- 检查依赖安装
- 验证配置文件
- 查看错误日志
- 测试网络连接

## 开发规范

### 1. 代码设计

- 低耦合，高内聚
- 完整的注释
- 完备的日志系统
- 避免冗余代码
- 工程最佳实践

### 2. 错误处理

- 统一的异常处理
- 详细的错误信息
- 合适的 HTTP 状态码
- 日志记录和监控

### 3. 测试策略

- 单元测试
- 集成测试
- 性能测试
- 压力测试

## 版本历史

- **v1.0.0** - 初始版本
  - 基础 OCR API 功能
  - macOS 自动启动支持
  - Bearer Token 认证
  - 完整的日志系统

## 总结

该项目成功将 ocrmac 封装为高并发的 HTTP API 服务，具备：

1. ✅ **完整的 API 接口** - 支持标准和详细两种响应格式
2. ✅ **高并发处理** - 基于 FastAPI 异步框架
3. ✅ **安全认证** - Bearer Token 认证机制
4. ✅ **macOS 自动启动** - 完整的 LaunchAgent 配置
5. ✅ **生产就绪** - 完整的日志、监控和错误处理
6. ✅ **易于部署** - 自动化安装和配置脚本
7. ✅ **符合规范** - 遵循代码设计最佳实践

项目已完成所有核心功能，可以直接部署使用。